---
title: "Stat4911PracticeProject"
author: "Armaan Sodhi, Max Margolis, Nathan Snyder, Gaurav Law"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
#install.packages("nyfcflights13")
library(nycflights13)
library(ggplot2)
library(dplyr)
library(randomForest)
library(tree)
library(lubridate)
```

```{r}
airlines <- nycflights13::airlines
airports <- nycflights13::airports
flights <- nycflights13::flights
planes <- nycflights13::planes
weather <- nycflights13::weather
```

```{r}
top10AirportsDest <- flights %>%
  group_by(dest) %>%
  count %>%
  arrange(desc(n)) %>%
  head(10)
```

```{r}
ggplot(top10AirportsDest, aes(x = reorder(dest, -n), y = n, fill = dest)) +
    geom_bar(stat = "identity") +
    labs(title = "Top 10 Airports by Destination",
         x = "Destination Airport",
         y = "Count") +
    scale_fill_brewer(palette = "Set3") +
    theme_minimal()
```

```{r}
AirportOrigin <- flights %>%
  group_by(origin) %>%
  count %>%
  arrange(desc(n)) %>%
  head(10)
```

```{r}
ggplot(AirportOrigin, aes(x = reorder(origin, -n), y = n, fill = origin)) +
    geom_bar(stat = "identity") +
  labs(title = "Top Airports by Origin",
       x = "Origin Airport",
       y = "Count") +
  scale_fill_brewer(palette = "Set2") +
  theme_minimal()

```

```{r}
flights %>%
  group_by(dest) %>%
  count() %>%
  summarise(frequency = n,
            origin) %>%
  arrange(-frequency)

flights <- flights %>%
  drop_na()

weather <- weather %>%
  drop_na()

flights$delay <- TRUE

for (i in 1:nrow(flights)) {
  if (flights$dep_delay[i] >= 15) {
    flights$delay[i] = TRUE}
  else if (flights$dep_delay[i] >= 0 && flights$dep_delay[i] < 15) {
    flights$delay[i] = FALSE
  } else {
    flights$delay[i] = "Early"
  }
}

flights %>% 
  ggplot(aes(x = delay, y = dep_delay)) +
  geom_boxplot(outlier.colour = "red", outlier.shape = 16, alpha = 0.6) +
  geom_jitter(width = 0.2, alpha = 0.6) +
  labs(title = "Boxplot of delays",
       x = "Delay?",
       y = "Frequency") +
  theme_classic()


flights %>%
  count(delay)
```

```{r plane sizes}

planes$size <- "Small"

for (i in 1:nrow(planes)) {
  if (planes$seats[i] <= 25) {
    planes$size[i] = "Small"
    } else if (planes$seats[i] > 25 && planes$seats[i] <= 180) {
    planes$size[i] = "Medium"
    } else if (planes$size[i] > 180) {
    planes$size[i] = "Large"
  }
}

planes %>% 
  ggplot(aes(x = size, y = engines)) +
  geom_boxplot(outlier.colour = "red", outlier.shape = 16, alpha = 0.6) +
  geom_jitter(width = 0.2, alpha = 0.6) +
  labs(title = "Boxplot of sizes",
       x = "Size of plane",
       y = "Frequency") +
  theme_classic()

planes %>%
  count(size)

```

```{r}
flights <- flights %>%
  left_join(airlines, by = c("carrier"))

delays <- flights %>%
  group_by(name) %>%
  summarise(min_dep_delay = min(dep_delay),
            avg_dep_delay = mean(dep_delay),
            max_dep_delay = max(dep_delay),
            min_arr_delay = min(arr_delay),
            avg_arr_delay = mean(arr_delay),
            max_arr_delay = max(arr_delay),
            overall = avg_arr_delay - avg_dep_delay)
```



To look at for weather relationship with delay:
  humid
  

  wind_dir
  wind_speed
  precip
  visib


# Merging datasets
```{r}

merged <- flights %>%
  left_join(weather, by = c("origin", "year", "month", "day", "hour", "time_hour"))

merged <- merged %>% drop_na() # drop NA values

# Planes have no significance in model

# planes <- planes[, !names(planes) %in% "speed"]

#merged <- merged %>% left_join(planes, by = c("tailnum"))

merged <- merged %>%
  mutate(delay = as.character(delay)) %>%
  mutate(delay = case_when(
    delay == "TRUE" ~ 1,
    delay == "Early" ~ -1,
    delay == "FALSE" ~ 0,
))
```


#Gets delayed/non-delayed flights
```{r}
delayFlights <- merged %>%
  filter(merged$delay == "TRUE")

nonDelayFlights <- merged %>%
  filter(merged$delay == "FALSE")
```


#EDA with Delayed/non-delayed Flights
```{r}
mean(delayFlights$visib)
mean(nonDelayFlights$visib)
```

```{r}
heatmap_data <- flights %>%
  filter(!is.na(dep_delay), !is.na(hour)) %>% # Filter out missing delays and hours
  group_by(carrier, hour) %>% # Group by carrier and hour of day
  summarize(avg_delay = mean(dep_delay, na.rm = TRUE)) %>% # Calculate average delay
  ungroup()

heatmap_data <- heatmap_data %>%
  left_join(airlines, by = c("carrier" = "carrier")) # Join with 'airlines' for names

ggplot(heatmap_data, aes(x = hour, y = name, fill = avg_delay)) +
  geom_tile() +
  scale_fill_gradient(low = "blue", high = "red", na.value = "grey50", name = "Avg Delay (min)") +
  labs(
    title = "Heatmap of Average Flight Delays",
    x = "Hour of Day",
    y = "Airline",
    caption = "Data source: nycflights13"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


```{r}
weather_by_airport <- weather %>%
  filter(!is.na(temp), !is.na(dewp), !is.na(humid), !is.na(wind_dir),
         !is.na(wind_speed), !is.na(wind_gust), !is.na(precip),
         !is.na(pressure), !is.na(visib)) %>%
  group_by(origin, month) %>% # Group by airport and month
  summarize(
    avg_temp = mean(temp, na.rm = TRUE),
    avg_dewp = mean(dewp, na.rm = TRUE),
    avg_humid = mean(humid, na.rm = TRUE),
    avg_wind_dir = mean(wind_dir, na.rm = TRUE),
    avg_wind_speed = mean(wind_speed, na.rm = TRUE),
    avg_wind_gust = mean(wind_gust, na.rm = TRUE),
    avg_precip = mean(precip, na.rm = TRUE),
    avg_pressure = mean(pressure, na.rm = TRUE),
    avg_visib = mean(visib, na.rm = TRUE)
  ) %>%
  pivot_longer(cols = starts_with("avg_"), names_to = "variable", values_to = "value") %>%
  mutate(variable = gsub("avg_", "", variable))

ggplot(weather_by_airport, aes(x = month, y = variable, fill = value)) +
  geom_tile() +
  scale_fill_gradient(low = "blue", high = "red", na.value = "grey50", name = "Average Value") +
  labs(
    title = "Heatmap of Weather Variables by Airport Over Time (by Month)",
    x = "Month",
    y = "Weather Variable",
    caption = "Data source: nycflights13"
  ) +
  facet_wrap(~origin) + # Facet by airport
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.text.y = element_text(size = 10)
  )
```






```{r}
size_counts <- planes %>%
  group_by(size) %>%
  summarize(count = n())

ggplot(size_counts, aes(x = size, y = count, fill = size)) +
  geom_bar(stat = "identity") +
  labs(
    title = "Counts of Small, Medium, and Large Planes",
    x = "Plane Size",
    y = "Count",
    fill = "Plane Size"
  ) +
  theme_minimal()
```




```{r}

flights_with_size <- flights %>%
  inner_join(planes, by = "tailnum") 

size_by_airport_counts <- flights_with_size %>%
  group_by(origin, size) %>% # Group by airport (origin) and size
  summarize(count = n()) %>%
  ungroup()

ggplot(size_by_airport_counts, aes(x = origin, y = count, fill = size)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Counts of Small, Medium, and Large Planes by Airport",
    x = "Airport",
    y = "Count",
    fill = "Plane Size"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```


```


```{r}
flights %>%
  count(delay) %>%
  ggplot(aes(x = delay, y = n, fill = delay)) +
  geom_bar(stat = "identity") +
  labs(
    title = "Proportion of Flights by Delay Status",
    x = "Delay Status",
    y = "Number of Flights",
    fill = "Delay Status"
  ) +
  theme_minimal()
```


Delay By Airport

```{r}
flights %>%
  filter(delay == TRUE) %>%
  count(origin) %>%
  ggplot(aes(x = origin, y = n, fill = origin)) +
  geom_bar(stat = "identity") +
  labs(
    title = "Number of Delayed Flights by Airport",
    x = "Airport",
    y = "Number of Delays",
    fill = "Airport"
  ) +
  theme_minimal()
```




Delays by Carrier


```{r}
flights %>%
  filter(delay == TRUE) %>%
  count(carrier) %>%
  left_join(airlines, by = "carrier") %>%
  ggplot(aes(x = name, y = n, fill = name)) +
  geom_bar(stat = "identity") +
  labs(
    title = "Number of Delayed Flights by Carrier",
    x = "Airline",
    y = "Number of Delays",
    fill = "Airline"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```



Delays Over Time

```{r}
flights %>%
  filter(delay == TRUE) %>%
  group_by(month) %>%
  summarize(count = n()) %>%
  ggplot(aes(x = month, y = count)) +
  geom_line(color = "red") +
  geom_point() +
  labs(
    title = "Number of Delays Over Time (by Month)",
    x = "Month",
    y = "Number of Delays"
  ) +
  theme_minimal()
```



Delays because of Precipitation

```{r}
flights_with_weather <- flights %>%
  inner_join(weather, by = c("origin", "time_hour"))

flights_with_weather %>%
  filter(!is.na(delay)) %>%
  ggplot(aes(x = delay, y = precip, fill = delay)) +
  geom_boxplot() +
  labs(
    title = "Effect of Precipitation on Flight Delays",
    x = "Delay Status",
    y = "Precipitation (inches)",
    fill = "Delay Status"
  ) +
  theme_minimal()
```


Delays by Time of Day

```{r}
flights %>%
  filter(delay == TRUE) %>%
  count(hour) %>%
  ggplot(aes(x = hour, y = n)) +
  geom_line(color = "blue") +
  geom_point() +
  labs(
    title = "Delays by Hour of the Day",
    x = "Hour",
    y = "Number of Delays"
  ) +
  theme_minimal()
```


Delays by Plane Size

```{r}
flights_with_planes <- flights %>%
  inner_join(planes, by = "tailnum")

flights_with_planes %>%
  filter(!is.na(size)) %>%
  count(size, delay) %>%
  ggplot(aes(x = size, y = n, fill = delay)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Delays by Plane Size",
    x = "Plane Size",
    y = "Count",
    fill = "Delay Status"
  ) +
  theme_minimal()
```


Heatmap of Delays (by Weather and Time)


```{r}
flights_with_weather %>%
  filter(delay == TRUE) %>%
  group_by(month, hour) %>%
  summarize(avg_precip = mean(precip, na.rm = TRUE)) %>%
  ggplot(aes(x = hour, y = month, fill = avg_precip)) +
  geom_tile() +
  scale_fill_gradient(low = "blue", high = "red") +
  labs(
    title = "Heatmap of Delays by Precipitation and Time",
    x = "Hour of Day",
    y = "Month",
    fill = "Average Precipitation"
  ) +
  theme_minimal()
```


#PNG images
```{r}
library(png)
url <- "https://logos-world.net/wp-content/uploads/2021/02/Alaska-Airlines-Logo-700x394.png"
filepath <- "alaskaAir.png"
download.file(url, filepath, mode = "wb")
alaskaAir <- readPNG(filepath)

url1 <- "https://logos-world.net/wp-content/uploads/2021/08/Hawaiian-Airlines-Logo-700x394.png"
filepath1 <- "hawaiianAir.png"
download.file(url1, filepath1, mode = "wb")
hawaiianAir <- readPNG(filepath1)

url2 <- "https://logos-world.net/wp-content/uploads/2023/01/Virgin-Atlantic-Logo-500x281.png"
filepath2 <- "Virgin.png"
download.file(url2, filepath2, mode = "wb")
virginAir <- readPNG(filepath2)

url3 <- "https://logos-world.net/wp-content/uploads/2023/05/Endeavor-Air-Logo-500x281.png"
filepath3 <- "Endeavor.png"
download.file(url3, filepath3, mode = "wb")
endeavorAir <- readPNG(filepath3)

url4 <- "https://1000logos.net/wp-content/uploads/2017/06/United-Airlines-Logo.png"
filepath4 <- "United.png"
download.file(url4, filepath4, mode = "wb")
unitedAir <- readPNG(filepath4)

url5 <- "https://logos-world.net/wp-content/uploads/2020/11/American-Airlines-Emblem.png"
filepath5 <- "American.png"
download.file(url5, filepath5, mode = "wb")
americanAir <- readPNG(filepath5)

url6 <- "https://logos-world.net/wp-content/uploads/2020/10/Southwest-Airlines-Emblem.png"
filepath6 <- "Southwest.png"
download.file(url6, filepath6, mode = "wb")
southwestAir <- readPNG(filepath6)

url7 <- "https://logos-world.net/wp-content/uploads/2021/08/Delta-Emblem.png"
filepath7 <- "Delta.png"
download.file(url7, filepath7, mode = "wb")
deltaAir <- readPNG(filepath7)

url8 <- "https://upload.wikimedia.org/wikipedia/commons/4/47/ExpressJet_Airlines%2C_LLC_-_Copy.png"
filepath8 <- "Express.png"
download.file(url8, filepath8, mode = "wb")
expressAir <- readPNG(filepath8)

url9 <- "https://1000logos.net/wp-content/uploads/2019/12/JetBlue-Airways-Logo.png"
filepath9 <- "JetBlue.png"
download.file(url9, filepath9, mode = "wb")
jetblueAir <- readPNG(filepath9)

url10 <- "https://www.aviatorcapital.com/wp-content/uploads/2017/11/Mesa-Airlines.png"
filepath10 <- "Mesa.png"
download.file(url10, filepath10, mode = "wb")
mesaAir <- readPNG(filepath10)

url11 <- "https://upload.wikimedia.org/wikipedia/commons/thumb/a/a6/US_Airways_Logo_2011.svg/800px-US_Airways_Logo_2011.svg.png"
filepath11 <- "USAirways.png"
download.file(url11, filepath11, mode = "wb")
usAirwaysAir <- readPNG(filepath11)

url12 <- "https://1000logos.net/wp-content/uploads/2023/06/SkyWest-Logo-500x281.png"
filepath12 <- "Skywest.png"
download.file(url12, filepath12, mode = "wb")
skywestAir <- readPNG(filepath12)

url13 <- "https://www.envoyair.com/wp-content/uploads/2024/03/Envoy-logo_blue-01-1.png"
filepath13 <- "Envoy.png"
download.file(url13, filepath13, mode = "wb")
envoyAir <- readPNG(filepath13)

url14 <- "https://logos-world.net/wp-content/uploads/2023/01/AirTran-Airways-Logo-500x281.png"
filepath14 <- "AirTran.png"
download.file(url14, filepath14, mode = "wb")
airtranAir <- readPNG(filepath14)

url15 <- "https://logos-world.net/wp-content/uploads/2021/03/Frontier-Airlines-Emblem.png"
filepath15 <- "Frontier.png"
download.file(url15, filepath15, mode = "wb")
frontierAir <- readPNG(filepath15)
```
```{r}
delays$name <- c(
  "AirTran",
  "Alaska",
  "American",
  "Delta",
  "Endeavor",
  "Envoy",
  "ExpressJet",
  "Frontier",
  "Hawaiian",
  "JetBlue",
  "Mesa",
  "SkyWest",
  "Southwest",
  "United",
  "USAirways",
  "Virgin"
)

logos <- list(
  Alaska = rasterGrob(alaskaAir, interpolate = TRUE),
  Hawaiian = rasterGrob(hawaiianAir, interpolate = TRUE),
  Virgin = rasterGrob(virginAir, interpolate = TRUE),
  Endeavor = rasterGrob(endeavorAir, interpolate = TRUE),
  United = rasterGrob(unitedAir, interpolate = TRUE),
  American = rasterGrob(americanAir, interpolate = TRUE),
  Southwest = rasterGrob(southwestAir, interpolate = TRUE),
  Delta = rasterGrob(deltaAir, interpolate = TRUE),
  ExpressJet = rasterGrob(expressAir, interpolate = TRUE),
  JetBlue = rasterGrob(jetblueAir, interpolate = TRUE),
  Mesa = rasterGrob(mesaAir, interpolate = TRUE),
  USAirways = rasterGrob(usAirwaysAir, interpolate = TRUE),
  SkyWest = rasterGrob(skywestAir, interpolate = TRUE),
  Envoy = rasterGrob(envoyAir, interpolate = TRUE),
  AirTran = rasterGrob(airtranAir, interpolate = TRUE),
  Frontier = rasterGrob(frontierAir, interpolate = TRUE)
)

logoGraph <- ggplot(delays, aes(x = avg_dep_delay, y = avg_arr_delay)) +
  geom_point(color = "white") + 
  xlim(0, max(delays$avg_dep_delay) + 2) +
  ylim(0, max(delays$avg_arr_delay) + 2) +
  labs(title = "Airline Delays", x = "Average Departure Delay", y = "Average Arrival Delay") +
  theme_minimal()

for (i in 1:nrow(delays)) {
  logoGraph <- logoGraph + annotation_custom(
    logos[[delays$name[i]]],
    xmin = delays$avg_dep_delay[i] - 1.5,
    xmax = delays$avg_dep_delay[i] + 1.5,
    ymin = delays$avg_arr_delay[i] - 1.5,
    ymax = delays$avg_arr_delay[i] + 1.5
  )
}

print(logoGraph)
```

```{r}
modelWeather <- glm(delay ~ temp + dewp + humid + wind_dir + wind_speed + wind_gust + precip + pressure + visib, data = merged)
summary(modelWeather)
```
We find that precip has a p value of 0.667210 which is greater than our alpha value of .05 so we would say that precipitation does not have a noticeable effect on delayed flights in the origin airport.
We find that wind speed has a p value of 0.490046 which is greater than our alpha value of .05 so we would say that precipitation does not have a noticeable effect on delayed flights in the origin airport.


```{r}
modelWeather <- glm(delay ~ temp + dewp + humid + wind_dir + wind_gust + pressure + visib, data = merged)
summary(modelWeather)
```

# Tree-Based Models

## All Factors

### Training

```{r all factors}
set.seed(101)
trainIndex <- sample(1:nrow(merged), 0.7 * nrow(merged))

training_data <- merged[trainIndex, ]
testing_data <- merged[-trainIndex, ]

mod_tree = tree(delay ~ ., data = training_data)
mod_tree

# get model for decision tree
summary(mod_tree)

# plot the tree in a dendrogram
plot(mod_tree, cex = 0.8)
text(mod_tree, pretty = 0, cex = 0.6)

# Find RMSE
mod_tree_pred = predict(mod_tree, newdata = training_data)
mod_tree_rmse = sqrt(mean((training_data$delay - mod_tree_pred)^2))
mod_tree_rmse

# Use K-fold cross validation to reduce tree complexity
cv_tree = cv.tree(mod_tree)
names(cv_tree)

cv_tree

# identify trends in deviance with respect to the size of the tree
with(cv_tree, plot(dev~size, type = 'b'))
```
```{r Random Forest with training}

# fit the random forest model
mod_rf = randomForest(delay ~ ., data = training_data,  mtry = sqrt(NCOL(training_data)-1), importance = TRUE)
mod_rf

plot(mod_rf)

mod_rf_pred = predict(mod_rf, newdata = training_data)
mod_rf_rmse  = sqrt(mean((training_data$delay - mod_rf_pred)^2))
mod_rf_rmse

# run lines together to compare variable importance in bagging vs. RF
varImpPlot(mod_rf, cex = 0.6)

# Compare the three RMSEs to judge which one we will use for testing
cat("Tree RMSE:", mod_tree_rmse, "\n")
cat("Random Forest RMSE:", mod_rf_rmse)


```

### Testing

```{r tree with testing}

set.seed(123)
mod_tree = tree(delay ~ ., data = training_data)
mod_tree

# get model for decision tree
summary(mod_tree)

# plot the tree
plot(mod_tree, cex = 0.8)   # Adjust tree size
text(mod_tree, pretty = 0, cex = 0.6)  # Adjust text size

mod_tree_pred = predict(mod_tree, newdata = testing_data)
mod_tree_rmse = sqrt(mean((testing_data$delay - mod_tree_pred)^2))
mod_tree_rmse

cv_tree = cv.tree(mod_tree)
names(cv_tree)

cv_tree

with(cv_tree, plot(dev~size, type = 'b'))
```

```{r Random Forest with testing}

set.seed(123)
mod_rf = randomForest(delay ~ ., data = training_data,  mtry = sqrt(NCOL(training_data)-1), importance = TRUE)
mod_rf

plot(mod_rf)

mod_rf_pred = predict(mod_rf, newdata = testing_data)
mod_rf_rmse  = sqrt(mean((testing_data$delay - mod_rf_pred)^2))
mod_rf_rmse

varImpPlot(mod_rf, cex = 0.6)

library(rpart)
library(rpart.plot)

tree_model <- rpart(delay ~ ., data = testing_data)
rpart.plot::rpart.plot(tree_model)

# Get the feature importance
importance_matrix <- randomForest::importance(mod_rf)

# Perform hierarchical clustering on feature importance
dendrogram <- hclust(dist(importance_matrix))

# Plot the dendrogram
plot(dendrogram, main = "Dendrogram of Feature Importance", xlab = "Features", ylab = "Distance")

cat("Tree RMSE:", mod_tree_rmse, "\n")
cat("Random Forest RMSE:", mod_rf_rmse)
```

## Month, dep_delay removed

```{r decision tree model}

flights_test <- merged
flights_test <- flights_test %>%
  drop_na()

flights_test <- flights_test[, !names(flights_test) %in% c("month", "dep_delay")]

set.seed(101)
trainIndex <- sample(1:nrow(flights_test), 0.7 * nrow(flights_test))

training_data <- flights_test[trainIndex, ]
testing_data <- flights_test[-trainIndex, ]

mod_tree = tree(delay ~ ., data = training_data)
mod_tree

# get model for decision tree
summary(mod_tree)

# plot the tree in a dendrogram
plot(mod_tree, cex = 0.8)
text(mod_tree, pretty = 0, cex = 0.6)

# Find RMSE
mod_tree_pred = predict(mod_tree, newdata = training_data)
mod_tree_rmse = sqrt(mean((training_data$delay - mod_tree_pred)^2))
mod_tree_rmse

# Use K-fold cross validation to reduce tree complexity
cv_tree = cv.tree(mod_tree)
names(cv_tree)

cv_tree

# identify trends in deviance with respect to the size of the tree
with(cv_tree, plot(dev~size, type = 'b'))



colSums(is.na(testing_data))

nrow(training_data)
nrow(testing_data)

```


```{r forest with training}

set.seed(123)
#colSums(is.na(training_data))

# fit the random forest model
mod_rf = randomForest(delay ~ ., data = training_data,  mtry = sqrt(NCOL(training_data)-1), importance = TRUE)
mod_rf

plot(mod_rf)

mod_rf_pred = predict(mod_rf, newdata = training_data)
mod_rf_rmse  = sqrt(mean((training_data$delay - mod_rf_pred)^2))
mod_rf_rmse

# run lines together to compare variable importance in bagging vs. RF
varImpPlot(mod_rf, cex = 0.6)

# Compare the three RMSEs to judge which one we will use for testing
cat("Tree RMSE:", mod_tree_rmse, "\n")
cat("Random Forest RMSE:", mod_rf_rmse)
```

```{r tree with testing}

set.seed(123)
mod_tree = tree(delay ~ ., data = training_data)
mod_tree

# get model for decision tree
summary(mod_tree)

# plot the tree
plot(mod_tree, cex = 0.8)   # Adjust tree size
text(mod_tree, pretty = 0, cex = 0.6)  # Adjust text size

mod_tree_pred = predict(mod_tree, newdata = testing_data)
mod_tree_rmse = sqrt(mean((testing_data$delay - mod_tree_pred)^2))
mod_tree_rmse

cv_tree = cv.tree(mod_tree)
names(cv_tree)

cv_tree

with(cv_tree, plot(dev~size, type = 'b'))
```


```{r Random Forest with testing}

set.seed(123)
mod_rf = randomForest(delay ~ ., data = training_data,  mtry = sqrt(NCOL(training_data)-1), importance = TRUE)
mod_rf

plot(mod_rf)

mod_rf_pred = predict(mod_rf, newdata = testing_data)
mod_rf_rmse  = sqrt(mean((testing_data$delay - mod_rf_pred)^2))
mod_rf_rmse

varImpPlot(mod_rf, cex = 0.6)

library(rpart)
library(rpart.plot)

tree_model <- rpart(delay ~ ., data = testing_data)
rpart.plot::rpart.plot(tree_model)

# Get the feature importance
importance_matrix <- randomForest::importance(mod_rf)

# Perform hierarchical clustering on feature importance
dendrogram <- hclust(dist(importance_matrix))

# Plot the dendrogram
plot(dendrogram, main = "Dendrogram of Feature Importance", xlab = "Features", ylab = "Distance")

cat("Tree RMSE:", mod_tree_rmse, "\n")
cat("Random Forest RMSE:", mod_rf_rmse)
```
