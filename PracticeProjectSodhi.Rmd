---
title: "Stat4911PracticeProject"
author: "Armaan Sodhi.23"
date: "2025-01-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(nycflights13)
library(ggplot2)
library(dplyr)
library(lubridate)
```

```{r}
airlines <- nycflights13::airlines
airports <- nycflights13::airports
flights <- nycflights13::flights
planes <- nycflights13::planes
weather <- nycflights13::weather
```

```{r}
top10AirportsDest <- flights %>%
  group_by(dest) %>%
  count %>%
  arrange(desc(n)) %>%
  head(10)
```

```{r}
ggplot(top10AirportsDest, aes(x = reorder(dest, -n), y = n)) +
    geom_bar(stat = "identity") +
  labs(title = "Top 10 Airports by Destination",
       x = "Destination Airport",
       y = "Count") +
  theme_minimal()
```

```{r}
AirportOrigin <- flights %>%
  group_by(origin) %>%
  count %>%
  arrange(desc(n)) %>%
  head(10)
```

```{r}
ggplot(AirportOrigin, aes(x = reorder(origin, -n), y = n)) +
    geom_bar(stat = "identity") +
  labs(title = "Top Airports by Origin",
       x = "Origin Airport",
       y = "Count") +
  theme_minimal()
```

```{r}
flights %>%
  group_by(dest) %>%
  count() %>%
  summarise(frequency = n,
            origin) %>%
  arrange(-frequency)

flights <- flights %>%
  drop_na()

weather <- weather %>%
  drop_na()

length(flights)

flights$delay <- TRUE


range(flights$dep_delay)
for (i in 1:nrow(flights)) {
  if (flights$dep_delay[i] >= 15) {
    flights$delay[i] = TRUE}
  else if (flights$dep_delay[i] >= 0 && flights$dep_delay[i] < 15) {
    flights$delay[i] = FALSE
  } else {
    flights$delay[i] = "Early"
  }
  }

flights %>%
  count(delay)

flights$dep_delay

str(flights)
```

```{r plane sizes}

planes$size <- "Small"

for (i in 1:nrow(planes)) {
  if (planes$seats[i] <= 25) {
    planes$size[i] = "Small"
    } else if (planes$seats[i] > 25 && planes$seats[i] <= 180) {
    planes$size[i] = "Medium"
    } else if (planes$size[i] > 180) {
    planes$size[i] = "Large"
  }
}

```

```
flights <- flights %>%
  left_join(airlines, by = c("carrier"))

delays <- flights %>%
  group_by(name) %>%
  summarise(min_dep_delay = min(dep_delay),
            avg_dep_delay = mean(dep_delay),
            max_dep_delay = max(dep_delay),
            min_arr_delay = min(arr_delay),
            avg_arr_delay = mean(arr_delay),
            max_arr_delay = max(arr_delay),
            overall = avg_arr_delay - avg_dep_delay)
```



To look at for weather relationship with delay:
  humid
  

  wind_dir
  wind_speed
  precip
  visib


#Merges 
```{r}
merged <- flights %>%
  left_join(weather, by = c("origin", "year", "month", "day", "hour", "time_hour"))

merged <- merged %>% drop_na() # drop NA values

merged <- merged %>%
  right_join(planes, by = c("tailnum"))
```


#Gets delayed/non-delayed flights
```{r}
delayFlights <- merged %>%
  filter(merged$delay == "TRUE")

nonDelayFlights <- merged %>%
  filter(merged$delay == "FALSE")
```


#EDA with Delayed/non-delayed Flights
```{r}
mean(delayFlights$visib)
mean(nonDelayFlights$visib)
```

```{r}
merged <- merged %>%
  mutate(delay = as.character(delay)) %>%
  mutate(delay = case_when(
    delay == "TRUE" ~ 1,
    delay == "Early" ~ -1,
    delay == "FALSE" ~ 0,
))
view(merged)
```

```{r}
modelWeather <- glm(delay ~ temp + dewp + humid + wind_dir + wind_speed + wind_gust + precip + pressure + visib, data = merged)
summary(modelWeather)
```
We find that precip has a p value of 0.667210 which is greater than our alpha value of .05 so we would say that precipitation does not have a noticeable effect on delayed flights in the origin airport.
We find that wind speed has a p value of 0.490046 which is greater than our alpha value of .05 so we would say that precipitation does not have a noticeable effect on delayed flights in the origin airport.


```{r}
modelWeather <- glm(delay ~ temp + dewp + humid + wind_dir + wind_gust + pressure + visib, data = merged)
summary(modelWeather)
```


#Trees then Bagging then Forest
```{r}
set.seed(101)  
trainIndex <- sample(1:nrow(merged), 0.7 * nrow(merged))

trainData <- merged[trainIndex, ]
testData <- merged[-trainIndex, ]


```


```{r}
heatmap_data <- flights %>%
  filter(!is.na(dep_delay), !is.na(hour)) %>% # Filter out missing delays and hours
  group_by(carrier, hour) %>% # Group by carrier and hour of day
  summarize(avg_delay = mean(dep_delay, na.rm = TRUE)) %>% # Calculate average delay
  ungroup()

heatmap_data <- heatmap_data %>%
  left_join(airlines, by = c("carrier" = "carrier")) # Join with 'airlines' for names

ggplot(heatmap_data, aes(x = hour, y = name, fill = avg_delay)) +
  geom_tile() +
  scale_fill_gradient(low = "blue", high = "red", na.value = "grey50", name = "Avg Delay (min)") +
  labs(
    title = "Heatmap of Average Flight Delays",
    x = "Hour of Day",
    y = "Airline",
    caption = "Data source: nycflights13"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


```{r}
weather_by_airport <- weather %>%
  filter(!is.na(temp), !is.na(dewp), !is.na(humid), !is.na(wind_dir),
         !is.na(wind_speed), !is.na(wind_gust), !is.na(precip),
         !is.na(pressure), !is.na(visib)) %>%
  group_by(origin, month) %>% # Group by airport and month
  summarize(
    avg_temp = mean(temp, na.rm = TRUE),
    avg_dewp = mean(dewp, na.rm = TRUE),
    avg_humid = mean(humid, na.rm = TRUE),
    avg_wind_dir = mean(wind_dir, na.rm = TRUE),
    avg_wind_speed = mean(wind_speed, na.rm = TRUE),
    avg_wind_gust = mean(wind_gust, na.rm = TRUE),
    avg_precip = mean(precip, na.rm = TRUE),
    avg_pressure = mean(pressure, na.rm = TRUE),
    avg_visib = mean(visib, na.rm = TRUE)
  ) %>%
  pivot_longer(cols = starts_with("avg_"), names_to = "variable", values_to = "value") %>%
  mutate(variable = gsub("avg_", "", variable))

ggplot(weather_by_airport, aes(x = month, y = variable, fill = value)) +
  geom_tile() +
  scale_fill_gradient(low = "blue", high = "red", na.value = "grey50", name = "Average Value") +
  labs(
    title = "Heatmap of Weather Variables by Airport Over Time (by Month)",
    x = "Month",
    y = "Weather Variable",
    caption = "Data source: nycflights13"
  ) +
  facet_wrap(~origin) + # Facet by airport
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.text.y = element_text(size = 10)
  )
```






```{r}
size_counts <- planes %>%
  group_by(size) %>%
  summarize(count = n())

ggplot(size_counts, aes(x = size, y = count, fill = size)) +
  geom_bar(stat = "identity") +
  labs(
    title = "Counts of Small, Medium, and Large Planes",
    x = "Plane Size",
    y = "Count",
    fill = "Plane Size"
  ) +
  theme_minimal()
```




```{r}

flights_with_size <- flights %>%
  inner_join(planes, by = "tailnum") 

size_by_airport_counts <- flights_with_size %>%
  group_by(origin, size) %>% # Group by airport (origin) and size
  summarize(count = n()) %>%
  ungroup()

ggplot(size_by_airport_counts, aes(x = origin, y = count, fill = size)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Counts of Small, Medium, and Large Planes by Airport",
    x = "Airport",
    y = "Count",
    fill = "Plane Size"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```


```


```{r}
flights %>%
  count(delay) %>%
  ggplot(aes(x = delay, y = n, fill = delay)) +
  geom_bar(stat = "identity") +
  labs(
    title = "Proportion of Flights by Delay Status",
    x = "Delay Status",
    y = "Number of Flights",
    fill = "Delay Status"
  ) +
  theme_minimal()
```


Delay By Airport

```{r}
flights %>%
  filter(delay == TRUE) %>%
  count(origin) %>%
  ggplot(aes(x = origin, y = n, fill = origin)) +
  geom_bar(stat = "identity") +
  labs(
    title = "Number of Delayed Flights by Airport",
    x = "Airport",
    y = "Number of Delays",
    fill = "Airport"
  ) +
  theme_minimal()
```




Delays by Carrier


```{r}
flights %>%
  filter(delay == TRUE) %>%
  count(carrier) %>%
  left_join(airlines, by = "carrier") %>%
  ggplot(aes(x = name, y = n, fill = name)) +
  geom_bar(stat = "identity") +
  labs(
    title = "Number of Delayed Flights by Carrier",
    x = "Airline",
    y = "Number of Delays",
    fill = "Airline"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```



Delays Over Time

```{r}
flights %>%
  filter(delay == TRUE) %>%
  group_by(month) %>%
  summarize(count = n()) %>%
  ggplot(aes(x = month, y = count)) +
  geom_line(color = "red") +
  geom_point() +
  labs(
    title = "Number of Delays Over Time (by Month)",
    x = "Month",
    y = "Number of Delays"
  ) +
  theme_minimal()
```



Delays because of Precipitation

```{r}
flights_with_weather <- flights %>%
  inner_join(weather, by = c("origin", "time_hour"))

flights_with_weather %>%
  filter(!is.na(delay)) %>%
  ggplot(aes(x = delay, y = precip, fill = delay)) +
  geom_boxplot() +
  labs(
    title = "Effect of Precipitation on Flight Delays",
    x = "Delay Status",
    y = "Precipitation (inches)",
    fill = "Delay Status"
  ) +
  theme_minimal()
```


Delays by Time of Day

```{r}
flights %>%
  filter(delay == TRUE) %>%
  count(hour) %>%
  ggplot(aes(x = hour, y = n)) +
  geom_line(color = "blue") +
  geom_point() +
  labs(
    title = "Delays by Hour of the Day",
    x = "Hour",
    y = "Number of Delays"
  ) +
  theme_minimal()
```


Delays by Plane Size

```{r}
flights_with_planes <- flights %>%
  inner_join(planes, by = "tailnum")

flights_with_planes %>%
  filter(!is.na(size)) %>%
  count(size, delay) %>%
  ggplot(aes(x = size, y = n, fill = delay)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Delays by Plane Size",
    x = "Plane Size",
    y = "Count",
    fill = "Delay Status"
  ) +
  theme_minimal()
```


Heatmap of Delays (by Weather and Time)


```{r}
flights_with_weather %>%
  filter(delay == TRUE) %>%
  group_by(month, hour) %>%
  summarize(avg_precip = mean(precip, na.rm = TRUE)) %>%
  ggplot(aes(x = hour, y = month, fill = avg_precip)) +
  geom_tile() +
  scale_fill_gradient(low = "blue", high = "red") +
  labs(
    title = "Heatmap of Delays by Precipitation and Time",
    x = "Hour of Day",
    y = "Month",
    fill = "Average Precipitation"
  ) +
  theme_minimal()
```




`





